<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INBDE Pro - Full Practice Quiz</title>
<style>
    :root {
        --primary-color: #fcdc11;
        --primary-dark: #121212;
        --light-bg: #f3f4f6;
        --white: #ffffff;
        --border-color: #e5e7eb;
        --correct-bg: #e6fcf5;
        --correct-border: #22c55e;
        --correct-text: #15803d;
        --incorrect-bg: #fff5f5;
        --incorrect-border: #ef4444;
        --incorrect-text: #b91c1c;
        --text-muted: #6b7280;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--light-bg); color: var(--primary-dark); margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
    .quiz-wrapper { display: flex; flex-direction: column; width: 1000px; max-width: 100%; background-color: var(--white); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); position: relative; min-height: 600px; }
    .brand-header { background-color: var(--primary-dark); color: var(--primary-color); padding: 15px 20px; font-weight: 800; font-size: 1.2em; border-bottom: 3px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; position: relative; }
    .header-center { position: absolute; left: 50%; transform: translateX(-50%); color: var(--white); font-family: monospace; font-size: 1.3em; font-weight: 700; background: rgba(255,255,255,0.15); padding: 5px 15px; border-radius: 6px; letter-spacing: 1px; }
    .progress-indicator { color: var(--white); font-size: 0.9em; font-weight: 400; z-index: 10; display: flex; align-items: center; gap: 15px; }
    .btn-stats-link { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 5px 10px; font-size: 0.8em; font-weight: 700; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; text-decoration: none; }
    .btn-stats-link:hover { background-color: rgba(252, 220, 17, 0.1); }
    .view-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; flex: 1; }
    #welcome-view { display: flex; } 
    #quiz-view { display: none; flex-direction: row; }
    #results-view { display: none; }
    .welcome-card { max-width: 500px; animation: fadeIn 0.5s ease-out; }
    .welcome-title { font-size: 2.8em; margin-bottom: 15px; color: var(--primary-dark); line-height: 1.1; }
    .welcome-subtitle { font-size: 1.1em; color: var(--text-muted); margin-bottom: 40px; }
    .welcome-info { display: flex; gap: 15px; justify-content: center; margin-bottom: 40px; }
    .info-pill { background: #f3f4f6; padding: 10px 20px; border-radius: 30px; font-weight: 600; font-size: 0.95em; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; }
    .btn-start { background-color: var(--primary-color); color: var(--primary-dark); padding: 16px 60px; font-size: 1.4em; font-weight: 800; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: all 0.1s; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-start:hover { transform: translateY(-2px); box-shadow: 0 6px 0 rgba(0,0,0,0.1); }
    .sidebar { width: 300px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; flex-shrink: 0; background-color: #fdfdfd; }
    .toggle-buttons { display: flex; padding: 10px; gap: 10px; justify-content: flex-end; border-bottom: 1px solid var(--border-color); }
    .btn-toggle { background: var(--white); border: 1px solid var(--primary-dark); padding: 6px 12px; font-weight: 700; cursor: pointer; font-size: 11px; text-transform: uppercase; transition: all 0.2s; }
    .btn-toggle:hover:not(.disabled-btn) { background-color: var(--primary-color); }
    .btn-toggle.disabled-btn { opacity: 0.3; cursor: not-allowed; border-color: #ccc; color: #999; }
    .info-block { border-bottom: 1px solid var(--border-color); }
    .info-header { background-color: #e5e7eb; padding: 8px 12px; font-weight: 700; font-size: 13px; border-bottom: 1px solid var(--border-color); }
    .info-content { padding: 12px; font-size: 14px; line-height: 1.4; }
    .main-content { flex-grow: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
    .scoreboard { display: flex; gap: 20px; background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 6px; padding: 10px 15px; margin-bottom: 20px; font-size: 0.9em; font-weight: 600; align-items: center; }
    .score-item { display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.gray { background-color: var(--text-muted); }
    .dot.green { background-color: var(--correct-border); }
    .dot.red { background-color: var(--incorrect-border); }
    .question-text { font-size: 18px; font-weight: 600; margin-bottom: 25px; }
    .options-list { display: flex; flex-direction: column; gap: 12px; }
    .option { display: flex; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 15px; transition: all 0.2s; background-color: var(--white); position: relative; }
    .option:hover:not(.disabled) { border-color: var(--primary-dark); background-color: #f9fafb; }
    .option-circle { height: 20px; width: 20px; border-radius: 50%; border: 1px solid #9ca3af; margin-right: 12px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; font-weight: bold; }
    .option.correct-answer { background-color: var(--correct-bg); border-color: var(--correct-border); font-weight: 600; color: var(--correct-text); }
    .option.correct-answer .option-circle { border-color: var(--correct-border); background-color: var(--correct-border); content: "‚úì"; }
    .option.wrong-answer { background-color: var(--incorrect-bg); border-color: var(--incorrect-border); color: var(--incorrect-text); }
    .option.wrong-answer .option-circle { border-color: var(--incorrect-border); background-color: var(--incorrect-border); }
    .option.disabled { cursor: default; pointer-events: none; }
    .feedback-message { margin-top: 20px; padding: 15px; border-radius: 6px; font-weight: 700; text-align: center; display: none; }
    .feedback-message.success { background-color: var(--correct-bg); color: var(--correct-text); border: 1px solid var(--correct-border); }
    .feedback-message.error { background-color: var(--incorrect-bg); color: var(--incorrect-text); border: 1px solid var(--incorrect-border); }
    .actions-area { margin-top: 25px; display: flex; justify-content: flex-end; padding-bottom: 20px; }
    .btn-next { background-color: var(--primary-dark); color: var(--primary-color); padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; font-weight: 700; cursor: pointer; display: none; transition: opacity 0.2s; }
    .btn-next:hover { opacity: 0.9; }
    .score-card { background-color: var(--primary-dark); color: var(--white); padding: 40px; border-radius: 12px; text-align: center; margin-bottom: 40px; width: 100%; max-width: 500px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); animation: fadeIn 0.6s ease-out; }
    .score-number { font-size: 4em; font-weight: 800; color: var(--primary-color); display: block; line-height: 1; margin: 10px 0; }
    .final-time-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
    .final-time-label { color: #888; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; }
    .final-time-value { color: var(--white); font-size: 1.4em; font-weight: 700; font-family: monospace; }
    .review-list { width: 100%; display: flex; flex-direction: column; gap: 20px; text-align: left; }
    .review-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background: var(--white); }
    .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
    .badge.correct { background: var(--correct-bg); color: var(--correct-text); border: 1px solid var(--correct-border); }
    .badge.incorrect { background: var(--incorrect-bg); color: var(--incorrect-text); border: 1px solid var(--incorrect-border); }
    .review-question { font-weight: 600; margin-bottom: 10px; font-size: 1.1em; }
    .btn-explain { background: transparent; border: 1px solid var(--border-color); padding: 5px 10px; cursor: pointer; font-size: 12px; border-radius: 4px; margin-top: 10px; }
    .btn-explain:hover { background: #f9fafb; }
    .explanation-box { display: none; margin-top: 15px; padding: 15px; background-color: #fdfdfd; border-left: 4px solid var(--primary-color); border: 1px solid var(--border-color); font-size: 14px; }
    .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { position: relative; max-width: 90%; max-height: 90%; animation: zoomIn 0.2s ease-out; }
    .modal-content img { max-width: 100%; max-height: 80vh; border-radius: 4px; border: 2px solid var(--white); display: block; }
    .close-btn { position: absolute; top: -40px; right: 0; color: #fff; font-size: 35px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .close-btn:hover { color: var(--primary-color); }
    .modal-caption { color: #fff; text-align: center; margin-top: 10px; font-size: 14px; font-weight: 500; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes zoomIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
    .brand-footer { background-color: var(--white); border-top: 1px solid var(--border-color); padding: 15px 30px; text-align: center; font-size: 0.9em; font-weight: 600; }
    @media (max-width: 768px) {
        #quiz-view { flex-direction: column; }
        .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); }
        .quiz-wrapper { width: 100%; border: none; border-radius: 0; }
        .scoreboard { flex-direction: column; align-items: flex-start; gap: 10px; }
        .header-center { position: static; transform: none; margin: 5px 0; display: inline-block; }
        .brand-header { flex-direction: column; }
    }
</style>
</head>
<body>

<div class="quiz-wrapper">
    <div class="brand-header">
        <span class="header-left">INBDE Pro</span>
        <span id="timer" class="header-center" style="display:none;">30:00</span>
        <span class="progress-indicator header-right" id="progress-text">
            Welcome
            <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>
        </span>
    </div>

    <div id="welcome-view" class="view-container">
        <div class="welcome-card">
            <h1 class="welcome-title">INBDE Pro Method</h1>
            <p class="welcome-subtitle">Simulated Practice Examination</p>
            <div class="welcome-info">
                <span class="info-pill">üìù 20 Questions</span>
                <span class="info-pill">‚è±Ô∏è 30 Minutes</span>
            </div>
            <button class="btn-start" onclick="startQuiz()">START QUIZ</button>
        </div>
    </div>

    <div id="quiz-view">
        <div class="sidebar">
            <div class="toggle-buttons">
                <button class="btn-toggle" id="btn-xray" onclick="openImage('xray')">X-RAYS</button>
                <button class="btn-toggle" id="btn-photo" onclick="openImage('photo')">PHOTOS</button>
            </div>
            <div class="info-block"><div class="info-header">Patient</div><div class="info-content" id="sidebar-patient">Loading...</div></div>
            <div class="info-block"><div class="info-header">Chief Complaint</div><div class="info-content" id="sidebar-cc">Loading...</div></div>
            <div class="info-block"><div class="info-header">History</div><div class="info-content" id="sidebar-history">Loading...</div></div>
            <div class="info-block"><div class="info-header">Current Findings</div><div class="info-content" id="sidebar-findings">Loading...</div></div>
        </div>
        <div class="main-content">
            <div class="scoreboard">
                <div class="score-item"><span class="dot gray"></span>Answered: <span id="score-answered">0</span></div>
                <div class="score-item"><span class="dot green"></span>Correct: <span id="score-correct">0</span></div>
                <div class="score-item"><span class="dot red"></span>Incorrect: <span id="score-incorrect">0</span></div>
            </div>
            <div class="question-text" id="question-text">Loading question...</div>
            <div class="options-list" id="options-container"></div>
            <div id="feedbackDisplay" class="feedback-message"></div>
            <div class="actions-area">
                <button class="btn-next" id="btn-next" onclick="nextQuestion()">Next Question ‚Üí</button>
            </div>
        </div>
    </div>

    <div id="results-view" class="view-container">
        <div class="score-card">
            <h2>Assessment Complete</h2>
            <span class="score-number" id="final-score">0%</span>
            <p id="score-text">You answered 0 out of 20 correctly.</p>
            <div class="final-time-container">
                <span class="final-time-label">Total Time Taken</span>
                <span id="final-time-value" class="final-time-value">0m 0s</span>
            </div>
        </div>
        <h3>Review Answers</h3>
        <div class="review-list" id="review-list"></div>
        <a href="stats.html" class="btn-start" style="margin-top: 40px; font-size: 1.1em; padding: 12px 30px;">View Global Stats</a>
    </div>
    <div class="brand-footer">INBDE Pro</div>
</div>

<div id="image-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="modal-img" src="" alt="Clinical Image">
        <div id="modal-caption" class="modal-caption"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // CONFIGURACI√ìN SUPABASE
    const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DATA
    const questions = [
        { id: 1, images: { xray: null, photo: null }, sidebar: { patient: "Male, 24 years old", cc: "\"I am extremely nervous...\"", history: "History of dental anxiety.", findings: "Class I caries #30." }, text: "A patient is undergoing a procedure with nitrous oxide and oxygen. They are relaxed, able to respond purposefully to verbal commands, and their airway reflexes are intact. Which level of sedation does this MOST LIKELY represent?", options: ["Minimal Sedation (Anxiolysis)", "Moderate Sedation", "Deep Sedation", "General Anesthesia"], correct: 0, explanation: "Minimal sedation is characterized by normal response to verbal commands." },
        { id: 2, images: { xray: null, photo: null }, sidebar: { patient: "Female, 28 years old", cc: "\"Bump on gum bleeds.\"", history: "2nd trimester pregnancy.", findings: "Erythematous mass on papilla." }, text: "A pregnant patient in her second trimester presents with a localized, round, red growth on the interdental papilla that bleeds easily. This lesion is MOST LIKELY a:", options: ["Fibroma", "Pyogenic Granuloma", "Giant Cell Granuloma", "Papilloma"], correct: 1, explanation: "Pyogenic granuloma (pregnancy tumor) is common in pregnancy due to hormonal changes." },
        // ... (Mant√©n el resto de tus 20 preguntas aqu√≠, las he resumido por espacio pero usa tu lista completa) ...
         { id: 20, images: { xray: null, photo: null }, sidebar: { patient: "Female, 35 years old", cc: "\"Throat closing up.\"", history: "Allergies.", findings: "Lip swelling, hypotension." }, text: "What is the critical, first-line drug that must be administered immediately for a patient experiencing anaphylactic shock?", options: ["Diphenhydramine", "Albuterol", "Epinephrine (0.3 mg 1:1000) IM", "Oxygen"], correct: 2, explanation: "Epinephrine is the first-line drug for anaphylaxis." }
    ];

    // VARIABLES
    let currentQuestionIndex = 0, userScore = 0, answeredCount = 0, correctCount = 0, incorrectCount = 0;
    let userAnswers = [], questionStartTime, timerInterval, totalTime = 30 * 60;

    // FUNCTIONS
    function showView(viewId) {
        document.getElementById('welcome-view').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('results-view').style.display = 'none';
        document.getElementById(viewId).style.display = viewId === 'quiz-view' ? 'flex' : 'flex';
        
        const progressText = document.getElementById('progress-text');
        if (viewId === 'welcome-view' || viewId === 'results-view') {
            progressText.innerHTML = (viewId === 'welcome-view') ? `Welcome <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>` : `Results <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>`;
        } else {
            progressText.innerHTML = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }
        document.getElementById('timer').style.display = viewId === 'quiz-view' ? 'inline-block' : 'none';
    }

    function startQuiz() { showView('quiz-view'); loadQuestion(); startTimer(); }
    
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timer');
        function update() {
            const m = Math.floor(totalTime / 60);
            let s = totalTime % 60;
            timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if (totalTime <= 0) { clearInterval(timerInterval); showResults(); } else { totalTime--; }
        }
        update();
        timerInterval = setInterval(update, 1000);
    }

    function loadQuestion() {
        const q = questions[currentQuestionIndex];
        questionStartTime = new Date();
        document.getElementById('progress-text').innerHTML = `Question ${currentQuestionIndex + 1} of ${questions.length} <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>`;
        
        document.getElementById('sidebar-patient').innerText = q.sidebar.patient || "N/A";
        document.getElementById('sidebar-cc').innerText = q.sidebar.cc || "N/A";
        document.getElementById('sidebar-history').innerText = q.sidebar.history || "N/A";
        document.getElementById('sidebar-findings').innerText = q.sidebar.findings || "N/A";

        const btnXray = document.getElementById('btn-xray');
        const btnPhoto = document.getElementById('btn-photo');
        if (q.images?.xray) { btnXray.classList.remove('disabled-btn'); btnXray.disabled = false; } else { btnXray.classList.add('disabled-btn'); btnXray.disabled = true; }
        if (q.images?.photo) { btnPhoto.classList.remove('disabled-btn'); btnPhoto.disabled = false; } else { btnPhoto.classList.add('disabled-btn'); btnPhoto.disabled = true; }

        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('feedbackDisplay').style.display = 'none';

        q.options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.onclick = () => checkAnswer(div, idx);
            div.innerHTML = `<div class="option-circle"></div><span>${String.fromCharCode(65 + idx)}. ${opt}</span>`;
            container.appendChild(div);
        });
        document.getElementById('btn-next').style.display = 'none';
    }

    function checkAnswer(el, idx) {
        if (document.querySelector('.option.disabled')) return;
        const q = questions[currentQuestionIndex];
        document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));
        
        const isCorrect = (idx === q.correct);
        userAnswers.push({ qIndex: currentQuestionIndex, selected: idx, isCorrect });
        answeredCount++;
        
        if (isCorrect) {
            correctCount++; userScore++;
            el.classList.add('correct-answer'); el.querySelector('.option-circle').innerText = '‚úì';
        } else {
            incorrectCount++;
            el.classList.add('wrong-answer'); el.querySelector('.option-circle').innerText = '‚úï';
            const correctEl = document.querySelectorAll('.option')[q.correct];
            correctEl.classList.add('correct-answer'); correctEl.querySelector('.option-circle').innerText = '‚úì';
        }
        
        document.getElementById('score-answered').innerText = answeredCount;
        document.getElementById('score-correct').innerText = correctCount;
        document.getElementById('score-incorrect').innerText = incorrectCount;
        
        const fb = document.getElementById('feedbackDisplay');
        fb.innerHTML = isCorrect ? "Correct! Well done." : "Incorrect.";
        fb.className = `feedback-message ${isCorrect ? 'success' : 'error'}`;
        fb.style.display = 'block';
        document.getElementById('btn-next').style.display = 'block';
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) loadQuestion(); else showResults();
    }

    function showResults() {
        clearInterval(timerInterval);
        showView('results-view');
        const pct = Math.round((userScore / questions.length) * 100);
        document.getElementById('final-score').innerText = pct + "%";
        document.getElementById('score-text').innerText = `You answered ${userScore} out of ${questions.length} correctly.`;
        
        const spent = (30 * 60) - totalTime;
        document.getElementById('final-time-value').innerText = `${Math.floor(spent/60)}m ${spent%60}s`;

        saveDataSupabase(pct, userScore, questions.length);

        const list = document.getElementById('review-list');
        list.innerHTML = '';
        userAnswers.forEach((ans, i) => {
            const q = questions[ans.qIndex];
            const item = document.createElement('div');
            item.className = 'review-item';
            item.innerHTML = `
                <div class="review-header"><span class="badge ${ans.isCorrect ? 'correct' : 'incorrect'}">${ans.isCorrect ? 'Correct' : 'Incorrect'}</span></div>
                <div class="review-question">${i+1}. ${q.text}</div>
                <div style="font-size:0.9em; margin-bottom:10px;">Correct: <strong>${q.options[q.correct]}</strong></div>
                <button class="btn-explain" onclick="toggleExpl(${i})">Explanation</button>
                <div class="explanation-box" id="expl-${i}"><strong>Rationale:</strong><br>${q.explanation}</div>
            `;
            list.appendChild(item);
        });
    }

    async function saveDataSupabase(score, correct, total) {
        console.log("Saving to Supabase...");
        const { error } = await supabase.from('resultados').insert([{ score, correct, total }]);
        if (error) console.error('Supabase Error:', error);
    }

    function toggleExpl(i) {
        const b = document.getElementById(`expl-${i}`);
        b.style.display = b.style.display === 'block' ? 'none' : 'block';
    }

    function openImage(type) {
        const q = questions[currentQuestionIndex];
        if (!q.images || !q.images[type]) return;
        const modal = document.getElementById('image-modal');
        document.getElementById('modal-img').src = q.images[type];
        document.getElementById('modal-caption').innerText = type === 'xray' ? "Radiograph" : "Photo";
        modal.style.display = 'flex';
    }
    function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
    window.onload = () => showView('welcome-view');
</script>
</body>
</html>
