<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INBDE Pro - Full Practice Quiz</title>
<style>
    /* --- CSS VARIABLES --- */
    :root {
        --primary-color: #fcdc11; --primary-dark: #121212; --light-bg: #f3f4f6;
        --white: #ffffff; --border-color: #e5e7eb; --correct-bg: #e6fcf5;
        --correct-border: #22c55e; --correct-text: #15803d; --incorrect-bg: #fff5f5;
        --incorrect-border: #ef4444; --incorrect-text: #b91c1c; --text-muted: #6b7280;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background-color: var(--light-bg); color: var(--primary-dark);
        margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh;
    }

    .quiz-wrapper {
        display: flex; flex-direction: column; width: 1100px; max-width: 100%;
        background-color: var(--white); box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);
        position: relative; min-height: 600px;
    }

    .brand-header {
        background-color: var(--primary-dark); color: var(--primary-color);
        padding: 15px 25px; font-weight: 800; font-size: 1.2em;
        border-bottom: 4px solid var(--primary-color);
        display: flex; justify-content: space-between; align-items: center;
    }

    .header-center {
        position: absolute; left: 50%; transform: translateX(-50%);
        color: var(--white); font-family: monospace; font-size: 1.4em; font-weight: 700;
        background: rgba(255,255,255,0.15); padding: 5px 15px; border-radius: 6px;
    }

    .btn-stats-link {
        background: transparent; border: 1px solid var(--primary-color);
        color: var(--primary-color); padding: 6px 12px; font-size: 0.8em;
        font-weight: 700; cursor: pointer; border-radius: 4px;
        text-decoration: none; text-transform: uppercase; transition: background 0.2s;
    }
    .btn-stats-link:hover { background-color: rgba(252, 220, 17, 0.2); }

    .view-container {
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; padding: 50px; text-align: center; flex: 1;
    }
    
    #welcome-view { display: flex; } 
    #quiz-view { display: none; flex-direction: row; flex: 1; } 
    #results-view { display: none; }

    .welcome-title { font-size: 3em; margin-bottom: 10px; line-height: 1.1; }
    .welcome-subtitle { font-size: 1.2em; color: var(--text-muted); margin-bottom: 40px; }
    .welcome-info { display: flex; gap: 15px; justify-content: center; margin-bottom: 40px; }
    .info-pill { background: #f3f4f6; padding: 8px 20px; border-radius: 30px; font-weight: 600; border: 1px solid var(--border-color); }

    .btn-start {
        background-color: var(--primary-color); color: var(--primary-dark);
        padding: 16px 60px; font-size: 1.4em; font-weight: 800; border: none;
        border-radius: 8px; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        transition: transform 0.1s;
    }
    .btn-start:hover { transform: translateY(-2px); }

    .sidebar {
        width: 320px; border-right: 1px solid var(--border-color);
        display: flex; flex-direction: column; flex-shrink: 0; background-color: #fafafa;
    }
    .toggle-buttons { padding: 15px; display: flex; gap: 10px; justify-content: center; border-bottom: 1px solid var(--border-color); background: #fff; }
    .btn-toggle { background: var(--white); border: 1px solid var(--primary-dark); padding: 8px 15px; font-weight: 700; cursor: pointer; }
    .btn-toggle:hover:not(.disabled-btn) { background-color: var(--primary-color); }
    .btn-toggle.disabled-btn { opacity: 0.3; cursor: not-allowed; }

    .info-block { border-bottom: 1px solid var(--border-color); }
    .info-header { background-color: #e5e7eb; padding: 10px 15px; font-weight: 700; font-size: 0.85em; text-transform: uppercase; }
    .info-content { padding: 15px; font-size: 0.95em; line-height: 1.5; color: #333; min-height: 20px; }

    .main-content { flex: 1; padding: 40px; display: flex; flex-direction: column; overflow-y: auto; background: var(--white); }

    .scoreboard {
        display: flex; gap: 20px; background-color: #f8f9fa;
        border: 1px solid var(--border-color); border-radius: 8px;
        padding: 12px 20px; margin-bottom: 30px; font-weight: 600; font-size: 0.9em;
    }
    .score-item { display: flex; align-items: center; gap: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; }
    .dot.gray { background: #ccc; } .dot.green { background: #22c55e; } .dot.red { background: #ef4444; }

    .question-text { font-size: 1.3em; font-weight: 600; margin-bottom: 30px; line-height: 1.4; }
    .options-list { display: flex; flex-direction: column; gap: 15px; }
    
    .option {
        display: flex; align-items: center; padding: 18px;
        border: 2px solid var(--border-color); border-radius: 8px;
        cursor: pointer; font-size: 1em; transition: all 0.2s;
    }
    .option:hover:not(.disabled) { border-color: var(--primary-dark); background-color: #fffce0; }
    
    .option-circle {
        height: 24px; width: 24px; border-radius: 50%;
        border: 2px solid #9ca3af; margin-right: 15px;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; font-weight: bold; color: white;
    }

    .option.correct-answer { background-color: var(--correct-bg); border-color: var(--correct-border); color: var(--correct-text); font-weight: 600; }
    .option.correct-answer .option-circle { border-color: var(--correct-border); background-color: var(--correct-border); content: "‚úì"; }
    .option.wrong-answer { background-color: var(--incorrect-bg); border-color: var(--incorrect-border); color: var(--incorrect-text); }
    .option.wrong-answer .option-circle { border-color: var(--incorrect-border); background-color: var(--incorrect-border); }
    .option.disabled { pointer-events: none; opacity: 0.8; }

    .feedback-message { margin-top: 25px; padding: 20px; border-radius: 8px; font-weight: 700; text-align: center; display: none; }
    .feedback-message.success { background: var(--correct-bg); color: var(--correct-text); border: 1px solid var(--correct-border); }
    .feedback-message.error { background: var(--incorrect-bg); color: var(--incorrect-text); border: 1px solid var(--incorrect-border); }

    .btn-next {
        background-color: var(--primary-dark); color: var(--primary-color);
        padding: 14px 30px; border: none; border-radius: 6px;
        font-size: 1.1em; font-weight: 700; cursor: pointer;
        margin-top: 20px; display: none; float: right;
    }

    .score-card { background-color: var(--primary-dark); color: var(--white); padding: 50px; border-radius: 15px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .score-number { font-size: 5em; font-weight: 900; color: var(--primary-color); display: block; margin: 10px 0; }
    .final-time-value { font-family: monospace; font-size: 1.4em; font-weight: bold; }

    .review-list { width: 100%; text-align: left; margin-top: 40px; display: flex; flex-direction: column; gap: 20px; }
    .review-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; background: #fff; }
    .badge { padding: 5px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
    .badge.correct { background: var(--correct-bg); color: var(--correct-text); }
    .badge.incorrect { background: var(--incorrect-bg); color: var(--incorrect-text); }
    .explanation-box { display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 4px solid var(--primary-color); }

    .modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
    .modal-content img { max-width: 90vw; max-height: 90vh; border: 2px solid #fff; border-radius: 4px; }
    .close-btn { position: absolute; top: 20px; right: 40px; color: #fff; font-size: 40px; cursor: pointer; }
    .brand-footer { padding: 15px; text-align: center; font-weight: 600; border-top: 1px solid var(--border-color); background: #fafafa; font-size: 0.9em; }
</style>
</head>
<body>

<div class="quiz-wrapper">
    <div class="brand-header">
        <span class="header-left">INBDE Pro</span>
        <span id="timer" class="header-center" style="display:none;">30:00</span>
        <span class="progress-indicator header-right" id="progress-text">
            Welcome
        </span>
    </div>

    <div id="welcome-view" class="view-container">
        <div class="welcome-card">
            <h1 class="welcome-title">INBDE Pro Method</h1>
            <p class="welcome-subtitle">Simulated Practice Examination</p>
            <div class="welcome-info">
                <span class="info-pill">üìù 20 Questions</span>
                <span class="info-pill">‚è±Ô∏è 30 Minutes</span>
            </div>
            <button class="btn-start" onclick="startQuiz()">START QUIZ</button>
            <br><br>
            <a href="stats.html" class="btn-stats-link">üìä View Global Stats</a>
        </div>
    </div>

    <div id="quiz-view">
        <div class="sidebar">
            <div class="toggle-buttons">
                <button class="btn-toggle" id="btn-xray" onclick="openImage('xray')">X-RAYS</button>
                <button class="btn-toggle" id="btn-photo" onclick="openImage('photo')">PHOTOS</button>
            </div>
            <div class="info-block"><div class="info-header">Patient</div><div class="info-content" id="sidebar-patient">Loading...</div></div>
            <div class="info-block"><div class="info-header">Chief Complaint</div><div class="info-content" id="sidebar-cc">Loading...</div></div>
            <div class="info-block"><div class="info-header">History</div><div class="info-content" id="sidebar-history">Loading...</div></div>
            <div class="info-block"><div class="info-header">Current Findings</div><div class="info-content" id="sidebar-findings">Loading...</div></div>
        </div>

        <div class="main-content">
            <div class="scoreboard">
                <div class="score-item"><span class="dot gray"></span>Answered: <span id="score-answered">0</span></div>
                <div class="score-item"><span class="dot green"></span>Correct: <span id="score-correct">0</span></div>
                <div class="score-item"><span class="dot red"></span>Incorrect: <span id="score-incorrect">0</span></div>
            </div>

            <div class="question-text" id="question-text">Loading question...</div>
            <div class="options-list" id="options-container"></div>
            <div id="feedbackDisplay" class="feedback-message"></div>
            <div class="actions-area">
                <button class="btn-next" id="btn-next" onclick="nextQuestion()">Next Question ‚Üí</button>
            </div>
        </div>
    </div>

    <div id="results-view" class="view-container">
        <div class="score-card">
            <h2>Assessment Complete</h2>
            <span class="score-number" id="final-score">0%</span>
            <p id="score-text">You answered 0 out of 20 correctly.</p>
            <div class="final-time-container">
                <span class="final-time-label">Total Time</span>
                <span id="final-time-value" class="final-time-value">0m 0s</span>
            </div>
        </div>
        <h3>Review Answers</h3>
        <div class="review-list" id="review-list"></div>
        <a href="stats.html" class="btn-start" style="margin-top:30px; text-decoration:none;">View Global Dashboard</a>
    </div>
    
    <div class="brand-footer">INBDE Pro</div>
</div>

<div id="image-modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="modal-img" src="" alt="Clinical Image">
        <div id="modal-caption" class="modal-caption" style="color:#fff; margin-top:10px;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // --- CONFIGURACI√ìN SUPABASE (CORREGIDA) ---
    const SUPABASE_URL = 'https://arumiloijqsxthlswojt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFydW1pbG9panFzeHRobHN3b2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzUzNTEsImV4cCI6MjA3OTAxMTM1MX0.5EaB81wglbbtNi8FOzJoDMNd_aOmMULzm27pDClJDSg';
    
    // Usamos 'supabaseClient' para evitar conflictos con la variable global de la librer√≠a
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- DATA ---
    const questions = [
        { id: 1, images: { xray: null, photo: null }, sidebar: { patient: "Male, 24 years old", cc: "\"I am extremely nervous...\"", history: "History of dental anxiety.", findings: "Class I caries #30." }, text: "A patient is undergoing a procedure with nitrous oxide and oxygen. They are relaxed, able to respond purposefully to verbal commands, and their airway reflexes are intact. Which level of sedation does this MOST LIKELY represent?", options: ["Minimal Sedation (Anxiolysis)", "Moderate Sedation", "Deep Sedation", "General Anesthesia"], correct: 0, explanation: "Minimal sedation is characterized by normal response to verbal commands." },
        { id: 2, images: { xray: null, photo: null }, sidebar: { patient: "Female, 28 years old", cc: "\"Bump on gum bleeds.\"", history: "2nd trimester pregnancy.", findings: "Erythematous mass on papilla." }, text: "A pregnant patient in her second trimester presents with a localized, round, red growth on the interdental papilla that bleeds easily. This lesion is MOST LIKELY a:", options: ["Fibroma", "Pyogenic Granuloma", "Giant Cell Granuloma", "Papilloma"], correct: 1, explanation: "Pyogenic granuloma (pregnancy tumor) is common in pregnancy due to hormonal changes." },
        { id: 3, images: { xray: null, photo: null }, sidebar: { patient: "Female, 32 years old", cc: "\"Need extraction.\"", history: "34 weeks pregnant (3rd Trimester).", findings: "Non-restorable #30. Feels faint lying flat." }, text: "To prevent supine hypotensive syndrome in a pregnant patient during the third trimester, how should the patient be positioned in the dental chair?", options: ["Completely supine", "Trendelenburg", "Left lateral decubitus", "Right lateral decubitus"], correct: 2, explanation: "Left lateral decubitus relieves pressure on the inferior vena cava." },
        { id: 4, images: { xray: null, photo: null }, sidebar: { patient: "Female, 30 years old", cc: "\"Is this safe for baby?\"", history: "1st Trimester.", findings: "Requires medication." }, text: "Which FDA pregnancy category describes drugs for which there is positive evidence of human fetal risk, but potential benefits may warrant use despite risks?", options: ["Category A", "Category B", "Category C", "Category D"], correct: 3, explanation: "Category D involves positive evidence of risk but potential benefits." },
        { id: 5, images: { xray: null, photo: null }, sidebar: { patient: "Female, 26 years old", cc: "\"Face swollen.\"", history: "18 weeks pregnant. No allergies.", findings: "Facial swelling from #19." }, text: "A pregnant patient requires an antibiotic. Which is considered SAFEST (Category B)?", options: ["Doxycycline", "Amoxicillin", "Clarithromycin", "Tetracycline"], correct: 1, explanation: "Amoxicillin is Category B (Safe)." },
        { id: 6, images: { xray: null, photo: null }, sidebar: { patient: "Male, 55 years old", cc: "\"Tired lately.\"", history: "Anemia.", findings: "Reviewing CBC." }, text: "Which component of a CBC specifically assesses variation in red blood cell size?", options: ["MCV", "MCH", "MCHC", "RDW"], correct: 3, explanation: "RDW (Red Cell Distribution Width) measures size variation." },
        { id: 7, images: { xray: null, photo: null }, sidebar: { patient: "Female, 40 years old", cc: "\"Pale gums.\"", history: "Heavy menstruation.", findings: "Low Hb, Low MCV." }, text: "Hemogram reveals Low Hb and Low MCV. What is the MOST LIKELY diagnosis?", options: ["Folic acid deficiency", "Vitamin B12 deficiency", "Iron Deficiency Anemia", "Liver disease"], correct: 2, explanation: "Low MCV (Microcytic) is classic for Iron Deficiency." },
        { id: 8, images: { xray: null, photo: null }, sidebar: { patient: "N/A", cc: "N/A", history: "Regulatory review.", findings: "N/A" }, text: "A drug with high abuse potential and NO accepted medical use in the US is classified as:", options: ["Schedule I", "Schedule II", "Schedule III", "Schedule IV"], correct: 0, explanation: "Schedule I drugs have no accepted medical use." },
        { id: 9, images: { xray: null, photo: null }, sidebar: { patient: "Male, 45 years old", cc: "\"Severe pain.\"", history: "Extraction of wisdom teeth.", findings: "Needs analgesic." }, text: "Which analgesic is classified as Schedule II?", options: ["Tylenol #3", "Ibuprofen", "Oxycodone", "Tramadol"], correct: 2, explanation: "Oxycodone is Schedule II." },
        { id: 10, images: { xray: null, photo: null }, sidebar: { patient: "Female, 22 years old", cc: "\"Hate pain.\"", history: "None.", findings: "Using Lidocaine." }, text: "Local anesthetics exert their primary effect by:", options: ["Blocking Ca+ channels", "Blocking Na+ channels", "Enhancing GABA", "Inhibiting prostaglandins"], correct: 1, explanation: "LAs block voltage-gated Sodium (Na+) channels." },
        { id: 11, images: { xray: null, photo: null }, sidebar: { patient: "Male, 65 years old", cc: "\"Cleaning.\"", history: "High cholesterol. Taking Atorvastatin.", findings: "Normal." }, text: "Statins work by competitively inhibiting which enzyme?", options: ["ACE", "COX", "HMG-CoA reductase", "MAO"], correct: 2, explanation: "Statins inhibit HMG-CoA reductase." },
        { id: 12, images: { xray: null, photo: null }, sidebar: { patient: "Male, 25 years old", cc: "\"Teeth rotting.\"", history: "Meth use.", findings: "Rampant caries." }, text: "Which is NOT typically associated with amphetamine use?", options: ["Weight loss", "Xerostomia", "Bradycardia", "Meth mouth"], correct: 2, explanation: "Amphetamines cause Tachycardia (fast heart rate), not Bradycardia." },
        { id: 13, images: { xray: null, photo: null }, sidebar: { patient: "Female, 45 years old", cc: "\"Nauseous.\"", history: "Gag reflex.", findings: "Pre-medication." }, text: "Scopolamine is primarily indicated for prevention of:", options: ["Hypertension", "Seizures", "Motion sickness/Nausea", "Infection"], correct: 2, explanation: "Scopolamine is an anticholinergic for motion sickness." },
        { id: 14, images: { xray: null, photo: null }, sidebar: { patient: "Male, 19 years old", cc: "None.", history: "Anxiety.", findings: "Lost consciousness after injection." }, text: "Immediate management for vasovagal syncope?", options: ["Epinephrine", "Supine with legs elevated", "Nitroglycerin", "Paper bag"], correct: 1, explanation: "Supine position increases blood flow to the brain." },
        { id: 15, images: { xray: null, photo: null }, sidebar: { patient: "Male, 68 years old", cc: "\"Chest tightness.\"", history: "Angina.", findings: "Conscious." }, text: "First-line drug for angina pectoris in dental chair?", options: ["Aspirin", "Nitroglycerin", "Epinephrine", "Albuterol"], correct: 1, explanation: "Nitroglycerin sublingual is first-line for angina." },
        { id: 16, images: { xray: null, photo: null }, sidebar: { patient: "Male, 62 years old", cc: "\"Implants.\"", history: "MI 2 months ago.", findings: "Elective surgery." }, text: "Recommended waiting period for elective care after MI?", options: ["6 weeks", "3 months", "6 months", "12 months"], correct: 2, explanation: "Standard recommendation is 6 months post-MI." },
        { id: 17, images: { xray: null, photo: null }, sidebar: { patient: "Female, 78 years old", cc: "\"Out of breath.\"", history: "CHF.", findings: "Dyspnea at rest." }, text: "NYHA Class IV CHF patients exhibit:", options: ["No limitation", "Symptoms with exertion", "Symptoms at rest", "Symptoms only supine"], correct: 2, explanation: "Class IV is severe, with symptoms at rest." },
        { id: 18, images: { xray: null, photo: null }, sidebar: { patient: "Male, 14 years old", cc: "\"Dizzy.\"", history: "Type 1 Diabetes. Skipped breakfast.", findings: "Sweating, pale." }, text: "Classic sign of hypoglycemia?", options: ["Thirst", "Polyuria", "Sweating/Irritability", "Fruity breath"], correct: 2, explanation: "Sweating (diaphoresis) is a classic sign of hypoglycemia." },
        { id: 19, images: { xray: null, photo: null }, sidebar: { patient: "Female, 10 years old", cc: "\"Can't breathe.\"", history: "Asthma.", findings: "Wheezing." }, text: "FIRST pharmacological intervention for acute asthma?", options: ["Oxygen", "Albuterol inhaler", "Epinephrine", "Corticosteroids"], correct: 1, explanation: "Short-acting beta-agonist (Albuterol) is first-line." },
        { id: 20, images: { xray: null, photo: null }, sidebar: { patient: "Female, 35 years old", cc: "\"Throat closing.\"", history: "Allergies.", findings: "Anaphylaxis." }, text: "Critical first-line drug for anaphylaxis?", options: ["Benadryl", "Albuterol", "Epinephrine", "Oxygen"], correct: 2, explanation: "Epinephrine is the only life-saving drug for anaphylaxis." }
    ];

    // --- LOGIC ---
    let currentQuestionIndex = 0, userScore = 0, answeredCount = 0, correctCount = 0, incorrectCount = 0;
    let userAnswers = [], questionStartTime, timerInterval, totalTime = 30 * 60;

    function showView(viewId) {
        document.getElementById('welcome-view').style.display = 'none';
        document.getElementById('quiz-view').style.display = 'none';
        document.getElementById('results-view').style.display = 'none';
        document.getElementById(viewId).style.display = viewId === 'quiz-view' ? 'flex' : 'flex';
        
        const progressText = document.getElementById('progress-text');
        if (viewId === 'welcome-view' || viewId === 'results-view') {
            progressText.innerHTML = (viewId === 'welcome-view') ? `Welcome <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>` : `Results <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>`;
        } else {
            progressText.innerHTML = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }
        document.getElementById('timer').style.display = viewId === 'quiz-view' ? 'inline-block' : 'none';
    }

    function startQuiz() { showView('quiz-view'); loadQuestion(); startTimer(); }
    
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        const timerDisplay = document.getElementById('timer');
        function update() {
            const m = Math.floor(totalTime / 60);
            let s = totalTime % 60;
            timerDisplay.innerText = `${m}:${s < 10 ? '0'+s : s}`;
            if (totalTime <= 0) { clearInterval(timerInterval); showResults(); } else { totalTime--; }
        }
        update();
        timerInterval = setInterval(update, 1000);
    }

    function loadQuestion() {
        const q = questions[currentQuestionIndex];
        questionStartTime = new Date();
        document.getElementById('progress-text').innerHTML = `Question ${currentQuestionIndex + 1} of ${questions.length} <a href="stats.html" class="btn-stats-link">üìä Global Stats</a>`;
        
        document.getElementById('sidebar-patient').innerText = q.sidebar.patient || "";
        document.getElementById('sidebar-cc').innerText = q.sidebar.cc || "";
        document.getElementById('sidebar-history').innerText = q.sidebar.history || "";
        document.getElementById('sidebar-findings').innerText = q.sidebar.findings || "";

        const btnXray = document.getElementById('btn-xray');
        const btnPhoto = document.getElementById('btn-photo');
        if (q.images?.xray) { btnXray.classList.remove('disabled-btn'); btnXray.disabled = false; } else { btnXray.classList.add('disabled-btn'); btnXray.disabled = true; }
        if (q.images?.photo) { btnPhoto.classList.remove('disabled-btn'); btnPhoto.disabled = false; } else { btnPhoto.classList.add('disabled-btn'); btnPhoto.disabled = true; }

        document.getElementById('question-text').innerText = q.text;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        document.getElementById('feedbackDisplay').style.display = 'none';
        document.getElementById('btn-next').style.display = 'none';

        q.options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.onclick = () => checkAnswer(div, idx);
            div.innerHTML = `<div class="option-circle"></div><span>${String.fromCharCode(65 + idx)}. ${opt}</span>`;
            container.appendChild(div);
        });
    }

    function checkAnswer(el, idx) {
        if (document.querySelector('.option.disabled')) return;
        const q = questions[currentQuestionIndex];
        document.querySelectorAll('.option').forEach(o => o.classList.add('disabled'));
        
        const isCorrect = (idx === q.correct);
        userAnswers.push({ qIndex: currentQuestionIndex, selected: idx, isCorrect });
        answeredCount++;
        
        if (isCorrect) {
            correctCount++; userScore++;
            el.classList.add('correct-answer'); el.querySelector('.option-circle').innerText = '‚úì';
        } else {
            incorrectCount++;
            el.classList.add('wrong-answer'); el.querySelector('.option-circle').innerText = '‚úï';
            const correctEl = document.querySelectorAll('.option')[q.correct];
            correctEl.classList.add('correct-answer'); correctEl.querySelector('.option-circle').innerText = '‚úì';
        }
        
        document.getElementById('score-answered').innerText = answeredCount;
        document.getElementById('score-correct').innerText = correctCount;
        document.getElementById('score-incorrect').innerText = incorrectCount;
        
        const fb = document.getElementById('feedbackDisplay');
        fb.innerHTML = isCorrect ? "Correct! Well done." : "Incorrect.";
        fb.className = `feedback-message ${isCorrect ? 'success' : 'error'}`;
        fb.style.display = 'block';
        document.getElementById('btn-next').style.display = 'block';
    }

    function nextQuestion() {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) loadQuestion(); else showResults();
    }

    function showResults() {
        clearInterval(timerInterval);
        showView('results-view');
        const pct = Math.round((userScore / questions.length) * 100);
        document.getElementById('final-score').innerText = pct + "%";
        document.getElementById('score-text').innerText = `You answered ${userScore} out of ${questions.length} correctly.`;
        
        const spent = (30 * 60) - totalTime;
        document.getElementById('final-time-value').innerText = `${Math.floor(spent/60)}m ${spent%60}s`;

        // ENVIAR A SUPABASE
        saveDataSupabase(pct, userScore, questions.length);

        const list = document.getElementById('review-list');
        list.innerHTML = '';
        userAnswers.forEach((ans, i) => {
            const q = questions[ans.qIndex];
            const item = document.createElement('div');
            item.className = 'review-item';
            item.innerHTML = `
                <div class="review-header"><span class="badge ${ans.isCorrect ? 'correct' : 'incorrect'}">${ans.isCorrect ? 'Correct' : 'Incorrect'}</span></div>
                <div class="review-question">${i+1}. ${q.text}</div>
                <div style="font-size:0.9em; margin-bottom:10px;">Correct: <strong>${q.options[q.correct]}</strong></div>
                <button class="btn-explain" onclick="toggleExpl(${i})">Explanation</button>
                <div class="explanation-box" id="expl-${i}"><strong>Rationale:</strong><br>${q.explanation}</div>
            `;
            list.appendChild(item);
        });
    }

    async function saveDataSupabase(score, correct, total) {
        console.log("Sending to Supabase...");
        const { error } = await supabaseClient.from('resultados').insert([{ score, correct, total }]);
        if (error) console.error('Supabase Error:', error);
        else console.log('Saved successfully!');
    }

    function toggleExpl(i) {
        const b = document.getElementById(`expl-${i}`);
        b.style.display = b.style.display === 'block' ? 'none' : 'block';
    }

    function openImage(type) {
        const q = questions[currentQuestionIndex];
        if (!q.images || !q.images[type]) return;
        const modal = document.getElementById('image-modal');
        document.getElementById('modal-img').src = q.images[type];
        document.getElementById('modal-caption').innerText = type === 'xray' ? "Radiograph" : "Photo";
        modal.style.display = 'flex';
    }
    function closeModal() { document.getElementById('image-modal').style.display = 'none'; }
    document.addEventListener('keydown', e => { if (e.key === "Escape") closeModal(); });
    
    // Initialize
    window.onload = () => showView('welcome-view');
</script>

</body>
</html>
